---
import { Image } from 'astro:assets';
import { books } from '../data/books.js';
import 'photoswipe/style.css';

import { ui } from '../i18n/ui';
const lang = Astro.currentLocale || 'es';
const t = ui[lang];
---

<section class="carousel-section" id="libros">
    <h2 class="section-title">{t['section.books']}</h2>
    <div class="carousel-stage">
        <button id="prev" class="nav-btn" aria-label="Libro anterior">❮</button>

        <div class="carousel-track">
            {books.map((book, index) => (
                <div class="book-card" data-index= {index}>
                    <div class="cover-wrapper">
                        <Image
                            src={book.cover}
                            alt={book.title}
                            width={400}
                            class="book-img"
                        />
                    </div>

                    
                    <div class="hidden-gallery" style="display:none;">
                    {book.gallery.map((img) => (
                        <a
                            href={img.src.src}
                            data-pswp-width={img.src.width}
                            data-pswp-height={img.src.height}
                            target="_blank"
                        ></a>
                    ))}
                    </div>
                </div>

            ))}
        </div>

        <button id="next" class="nav-btn" aria-label="Siguiente libro">❯</button>
    
    </div>
</section>

<style>

.carousel-section {
    padding: 4rem 0;
    text-align: center;
    overflow: hidden;
    
}

.section-title {
        font-size: 2.5rem; 
        text-align: center;
        margin-bottom: 3rem;
        color: #333;
        position: relative;
        display: inline-block;
        z-index: 1;
    }

    .section-title::after {
        content: '';
        position: absolute;
        left: -10px;
        bottom: 5px; 
        width: calc(100% + 20px);
        height: 15px;
        background-color: #67b3ec;
        opacity: 0.4; 
        z-index: -1; 
        transform: rotate(-1deg); 
        border-radius: 20px 5px 20px 5px; 
    }

.carousel-stage {
    position: relative;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    perspective: 1000px;
    padding: 50px 0;
}

.carousel-track {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 80px;
    height: 800px;
    transition: transform 0.5s ease;
    will-change: transform;
    width: max-content; 
    min-width: 100%;
    padding-left: 0;
    padding-right: 0;
    padding: 0 40px;
}

.book-card {
    width: 450px;
    transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    opacity: 0.5;
    transform: scale(0.8);
    position: relative;
    z-index: 1;
    cursor: pointer;
    flex-shrink: 0;
    margin: 0;
}

.cover-wrapper img {
    width: 100%;
    height: auto;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    display: block;
}

.book-card.active {
    opacity: 1;
    transform: translateX(0) scale(1.2) !important;
    z-index: 10;
    margin: 0;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
}

.book-card.active .book-title {
    opacity: 1;
}

.nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    z-index: 20;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.nav-btn:hover {
    transform: translateY(-50%) scale(1.1);
    background: #EB82BE;
    color: white;
}

#prev { left: 20px; }
#next { right: 20px; }


@media (max-width: 1025px) {
    
    .carousel-section {
        padding: 1rem 0;
    }
    
    .carousel-track {
        height: 400px;
        gap: 20px;
    }

    .section-title {
        font-size: 2rem; 
        text-align: center;
        margin-bottom: 3rem;
        color: #333;
        position: relative;
        display: inline-block;
        z-index: 1;
    }

    .section-title::after {
        content: '';
        position: absolute;
        left: -10px;
        bottom: 5px; 
        width: calc(100% + 20px);
        height: 15px;
        background-color: #67b3ec;
        opacity: 0.4; 
        z-index: -1; 
        transform: rotate(-1deg); 
        border-radius: 20px 5px 20px 5px; 
    }

    .book-card {
        width: 55vw;
        max-width: 250px;
    }

    .book-card.active {
        transform: scale(1.05) !important;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }

    .nav-btn {
        width: 35px;
        height: 35px;
        font-size: 18px;
        background: rgba(255,255,255,0.9);
    }

    #prev { left : 2px; }
    #next {right : 2px; }

}

</style>

<script>
    import PhotoSwipeLightbox from 'photoswipe/lightbox';

    const track = document.querySelector('.carousel-track');

    if (track) {

        const cards = document.querySelectorAll('.book-card');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
    
    // Empezamos en el medio
    let currentIndex = Math.floor(cards.length / 2);
    
    function updateCarousel() {
        // 1. OBTENER EL ESCENARIO Y SU CENTRO
        const stage = document.querySelector('.carousel-stage');
        const stageCenter = stage.offsetWidth / 2;
        
        // 2. LEER LAS MEDIDAS REALES DEL DOM (La clave del éxito)
        // Leemos el ancho de la primera carta (es el ancho base para todas)
        const cardWidth = cards[0].offsetWidth;
        
        // Leemos el 'gap' directamente del CSS computado (si falla, asumimos 0)
        const trackStyle = window.getComputedStyle(track);
        const gap = parseFloat(trackStyle.gap) || 0;
        
        // Leemos si hay algún padding lateral en el track que debamos considerar
        const trackPaddingLeft = parseFloat(trackStyle.paddingLeft) || 0;

        cards.forEach((card, index) => {
            card.classList.remove('active');

            if (index === currentIndex) {
                card.classList.add('active');
                
                // 3. FÓRMULA DE CENTRADO EXACTO
                // Distancia desde el inicio del track hasta el borde izquierdo de ESTA carta
                // (Ancho + Espacio) * Cantidad de cartas anteriores
                const distanceToCard = index * (cardWidth + gap);
                
                // Posición del centro de la carta (respecto al track)
                // Es la distancia + el padding inicial del track + la mitad de la carta
                const cardCenterInTrack = distanceToCard + trackPaddingLeft + (cardWidth / 2);

                // 4. EL MOVIMIENTO FINAL
                // Queremos que 'cardCenterInTrack' coincida con 'stageCenter'
                const moveX = stageCenter - cardCenterInTrack;

                track.style.transform = `translateX(${moveX}px)`;
            }
        });
    }
    

    // --- EVENTOS ---
    nextBtn.addEventListener('click', () => {
        currentIndex++;
        if (currentIndex >= cards.length) currentIndex = 0;
        updateCarousel();
    });

    prevBtn.addEventListener('click', () => {
        currentIndex--;
        if(currentIndex < 0) currentIndex = cards.length - 1;
        updateCarousel();
    });

    // Evento Resize optimizado
    window.addEventListener('resize', () => {
        // Ejecutamos inmediatamente para feedback rápido
        updateCarousel(); 
    });

    // --- PHOTOSWIPE ---
    cards.forEach((card, index) => {
        const galleryElement = card.querySelector('.hidden-gallery');
        if (galleryElement) {
            const lightbox = new PhotoSwipeLightbox({
                gallery: galleryElement,
                children: 'a',
                pswpModule: () => import('photoswipe'),
                paddingFn: () => ({ top: 0, bottom: 30, left: 0, right: 0 }),
            });
            lightbox.init();

            card.addEventListener('click', () => {
                if (index === currentIndex) {
                    const firstLink = galleryElement.querySelector('a');
                    if(firstLink) firstLink.click();
                } else {
                    currentIndex = index;
                    updateCarousel();
                }
            });
        }
    });

    // Arrancar
    // Usamos 'load' para asegurar que las imágenes cargaron y tienen ancho real
    window.addEventListener('load', updateCarousel);
    // Y un timeout de respaldo por si acaso
    setTimeout(updateCarousel, 100);
}

</script>